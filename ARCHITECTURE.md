# iris 系统架构图（v2.0）

## 1. 系统总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          iris 数字生命系统                                │
│                                                                         │
│  ┌──────────┐  ┌──────────────┐  ┌──────────────┐  ┌───────────────┐  │
│  │ CLI 入口  │  │ Boot Guardian│  │  LLM 抽象层   │  │ PostgreSQL    │  │
│  │ (cli/)   │  │  (boot/)     │  │   (llm/)     │  │  (persistence) │  │
│  └────┬─────┘  └──────┬───────┘  └──────┬───────┘  └──────┬────────┘  │
│       │                │                 │                  │           │
│  ═════╪════════════════╪═════════════════╪══════════════════╪═══════    │
│       ▼                ▼                 ▼                  ▼           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Runtime 调度层 (runtime/)                     │   │
│  │  ┌────────────┐  ┌───────────────┐  ┌──────────┐              │   │
│  │  │ scheduler  │  │ loop_control  │  │ shutdown  │              │   │
│  │  │ (tick循环)  │  │ (频率控制)     │  │ (优雅关闭) │              │   │
│  │  └────────────┘  └───────────────┘  └──────────┘              │   │
│  └──────────────────────────┬────────────────────────────────────┘   │
│                              │                                       │
│                    ┌─────────┼─────────┐                             │
│                    ▼         ▼         ▼                             │
│  ┌──────────────┐  ┌──────────┐  ┌──────────────────┐              │
│  │  对话管理层    │  │ 感觉门控  │  │    认知核心       │              │
│  │ (dialogue/)  │  │(sensory/) │  │  (cognition/)    │              │
│  └──────┬───────┘  └────┬─────┘  └────────┬─────────┘              │
│         │               │                  │                         │
│         ▼               ▼                  ▼                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐          │
│  │  决策执行层    │  │   记忆系统    │  │   内驱成长        │          │
│  │ (decision/   │  │  (memory/)   │  │ (self_drive/)    │          │
│  │  action/)    │  │              │  │ 规则: 未匹配→codegen│         │
│  └──────┬───────┘  └──────┬───────┘  └────────┬─────────┘          │
│         │               │                     │                     │
│         ▼               ▼                     ▼                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐          │
│  │ Capability   │  │  身份系统     │  │  代码生成引擎     │          │
│  │  生命周期     │  │ (identity/)  │  │  (codegen/)      │          │
│  │(capability/) │  │  KV 存储     │  │                  │          │
│  └──────────────┘  └──────────────┘  └──────────────────┘          │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  环境感知     │  │  资源空间     │  │   I/O 层     │              │
│  │(environment/)│  │(resource_sp/)│  │   (io/)      │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└─────────────────────────────────────────────────────────────────────┘
```

## 2. Tick 循环（8 步）

```
每个 Tick（100ms 正常 / 500ms 空闲 / 2000ms 休眠）
═══════════════════════════════════════════════════════════════════

 步骤 1: 收集输入
 ┌─────────────┐  ┌──────────────┐  ┌───────────────────┐
 │ 用户输入     │  │ 系统事件      │  │ 内部思维           │
 │(CLI 文本)   │  │(降级/能力/硬件)│  │(回放/固化/叙事)    │
 └──────┬──────┘  └──────┬───────┘  └─────────┬─────────┘
        │                │                    │
        ▼                ▼                    ▼
 ┌──────────────────────────────────────────────────┐
 │              统一事件队列（有界 256）               │
 └──────────────────────┬───────────────────────────┘
                        │
 步骤 2: 感觉门控        │
 ┌──────────────────────────────────────────────────┐
 │  规则过滤 → 四维打分                               │
 │  novelty(0.35) + urgency(0.25)                   │
 │  + complexity(0.25) + task_relevance(0.15)       │
 │  < noise_floor(0.20) → 丢弃                      │
 │  urgent_bypass ≥ 0.82 → 跳过 embedding           │
 └──────────────────────┬───────────────────────────┘
                        │
 步骤 3: 路由分发        │
 ┌──────────────────────────────────────────────────┐
 │  TextDialogue(外部→高优先级)                       │
 │  InternalSignal(内部→低优先级)                     │
 │  SystemEvent(直接分发)                             │
 └──────────────────────┬───────────────────────────┘
                        │
 步骤 4: 快慢双系统（并行）│
 ┌─────────────────────┐    ┌──────────────────────────┐
 │    Fast Path         │    │      Slow Path            │
 │  (< 50ms, 规则驱动)   │    │  (tokio::spawn, LLM辅助)   │
 │                     │    │                          │
 │ 触发: threat≥0.75   │    │ 触发: complexity≥0.55    │
 │   或 deadline≤120ms │    │   或 uncertainty≥0.40    │
 │                     │    │                          │
 │ capability匹配      │    │ LLM任务分解              │
 │ → ReflexDecision    │    │ → capability编排          │
 │ 无匹配→DirectLlm    │    │ → DeliberateDecision      │
 └─────────┬───────────┘    └────────────┬─────────────┘
           │                             │
           ▼                             ▼
 步骤 5: 决策融合
 ┌──────────────────────────────────────────────────┐
 │  Normal:  slow×0.6 vs fast×0.4                   │
 │  High/Critical: fast×0.7 vs slow×0.3             │
 │  连续3 tick Critical → fast-only                  │
 └──────────────────────┬───────────────────────────┘
                        │
 步骤 6: 动作执行        │
 ┌──────────────────────────────────────────────────┐
 │  scorer → calibrator → executor → Outcome        │
 │  DirectLlmFallback → LLM直接响应                  │
 │  async_codegen → 后台能力构建                      │
 └──────────────────────┬───────────────────────────┘
                        │
 步骤 7: 学习更新        │
 ┌──────────────────────────────────────────────────┐
 │  Self-Critic → capability_score / codegen_history │
 │  / user_preference 三张表                         │
 └──────────────────────┬───────────────────────────┘
                        │
 步骤 8: 记忆写入        │
 ┌──────────────────────────────────────────────────┐
 │  工作记忆写入 → 情节记忆持久化                      │
 │  重要事件 → narrative_event 表                     │
 └──────────────────────┬───────────────────────────┘
                        │
                        ▼
                   下一个 tick

 ═══ 独立异步任务（不在 tick 循环内）═══
 ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
 │ 记忆固化      │  │ 经验回放      │  │ 资源维护      │
 │ 每30min      │  │ salience>0.45│  │ 按压力触发    │
 │ 情节→语义    │  │ 模式扫描      │  │ 压缩/归档/淘汰│
 └──────────────┘  └──────────────┘  └──────────────┘
 ┌──────────────┐  ┌──────────────┐
 │ 内驱成长      │  │ 休眠周期      │
 │ 未匹配→codegen│  │ energy<0.2   │
 │ 排队构建能力  │  │ 深度维护+恢复 │
 └──────────────┘  └──────────────┘
```

## 3. 认知核心

```
  SensoryEvent + SalienceScore
          │
          ▼
  ┌───────────────┐
  │ perception.rs │  特征提取 → PerceptFeature
  │ threat/complexity/intent_tag
  └───────┬───────┘
          │
    ┌─────┴──────────────────────┐
    │                            │
    ▼                            ▼
  ┌──────────────┐      ┌───────────────────┐
  │  Fast Path   │      │  association.rs   │
  │ LRU缓存      │      │  语义整合 + 记忆检索│
  │ (1024条,300s)│      │  (top3, >0.6)     │
  │              │      └───────┬───────────┘
  │ ReflexDecision│             │
  │ 或 DirectLlm │             ▼
  └──────┬───────┘      ┌───────────────────┐
         │              │   Slow Path       │
         │              │   tokio::spawn    │
         │              │   LLM任务分解      │
         │              │   capability编排   │
         │              │ DeliberateDecision│
         │              └───────┬───────────┘
         │                      │
         ▼                      ▼
  ┌──────────────────────────────────────┐
  │         arbitration.rs               │
  │  Normal:  slow×0.6 vs fast×0.4      │
  │  High/Crit: fast×0.7 vs slow×0.3   │
  │  连续3 tick Critical → fast-only    │
  │                                      │
  │  direct_response.rs                  │
  │  (无capability时 LLM直接响应)         │
  └──────────────────┬───────────────────┘
                     │
                     ▼ Decision
              决策执行层 (decision/ + action/)
```

## 4. 记忆系统（v1 简化版）

```
  ┌─────────────────────────────────────────────────────┐
  │                  记忆系统（PostgreSQL）                 │
  │                                                     │
  │  ┌─── 进程内 RAM ──────────────────────────────┐   │
  │  │  ┌──────────────────────────────────────┐   │   │
  │  │  │       Working Memory (working.rs)    │   │   │
  │  │  │  环形缓冲, 最多 32 条目 / 8 活跃主题   │   │   │
  │  │  │  淘汰: evict = (now-access)/TTL      │   │   │
  │  │  │         - 0.3*salience               │   │   │
  │  │  └──────────────────────────────────────┘   │   │
  │  │  + AffectState 快照                          │   │
  │  └─────────────────────────────────────────────┘   │
  │                                                     │
  │  ┌─── PostgreSQL ─────────────────────────────────┐   │
  │  │                                             │   │
  │  │  ┌──────────────┐  ┌──────────────┐        │   │
  │  │  │ episodes 表   │  │ knowledge 表  │        │   │
  │  │  │ 情节记忆      │  │ 语义记忆      │        │   │
  │  │  │ content/emb  │  │ summary/emb  │        │   │
  │  │  │ salience     │  │ source_ids   │        │   │
  │  │  │ is_consolidated│ │              │        │   │
  │  │  └──────┬───────┘  └──────────────┘        │   │
  │  │         │                                   │   │
  │  │         ▼                                   │   │
  │  │  ┌──────────────────────────────────────┐  │   │
  │  │  │     consolidation.rs (后台任务)       │  │   │
  │  │  │  每30min: 未固化情节 → LLM提炼 →     │  │   │
  │  │  │  写入 knowledge 表                    │  │   │
  │  │  └──────────────────────────────────────┘  │   │
  │  │                                             │   │
  │  │  ┌──────────────┐                          │   │
  │  │  │  replay.rs   │  salience > 0.45 回放    │   │
  │  │  └──────────────┘                          │   │
  │  └─────────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────────┘
```

## 5. Capability 生命周期状态机

```
                    codegen 产物写入
                         │
                         ▼
                  ┌──────────────┐
                  │    staged    │
                  └──────┬───────┘
                         │
              ┌──────────┴──────────┐
              │ 自测通过              │ 自测失败
              ▼                      ▼
     ┌─────────────────┐    ┌───────────────┐
     │active_candidate │    │  quarantined  │◄──── 崩溃/回归失败
     └────────┬────────┘    └───────┬───────┘
              │                     │
              │ 连续运行10min        │ 新版本修复
              ▼                     ▼
     ┌─────────────────┐    重新进入 staged
     │   confirmed     │
     │   (= LKG)      │    quarantine_count ≥ 3
     └────────┬────────┘    + 用户确认
              │                     │
              │ 用户确认退役          ▼
              ▼              ┌──────────────┐
     ┌─────────────────┐    │   retired    │
     │    retired      │    └──────────────┘
     └─────────────────┘

  IPC 协议: stdin/stdout NDJSON
  ┌──────────┐  CapabilityRequest   ┌──────────────┐
  │  iris    │ ──────────────────► │  capability  │
  │  主进程   │ ◄────────────────── │  子进程      │
  └──────────┘  CapabilityResponse  └──────────────┘
                (两个独立 tokio task 分离读写)
```

## 6. Boot & Safe Mode 状态机

```
  ┌──────────────────────────────────────────────────┐
  │              启动序列 (guardian.rs)                │
  │                                                  │
  │  1. DATABASE_URL 环境变量  ─── 缺失→报错退出         │
  │  2. PostgreSQL 连接 + 迁移                          │
  │  3. IrisCfg::load() 从 iris_config 表加载           │
  │     （表空则写入默认值）                               │
  │  4. Seed LLM 配置（DB空 且 环境变量存在时）         │
  │  5. Bootstrap 各模块                              │
  └──────────────────────┬───────────────────────────┘
                         │
              ┌──────────┴──────────┐
              │ 成功                 │ 连续3次core启动失败
              ▼                     ▼
     ┌──────────────┐      ┌──────────────┐
     │  Normal Mode │      │  Safe Mode   │
     │  全功能运行   │      │  core-only   │
     └──────────────┘      └──────┬───────┘
                                  │
                           连续5 tick健康
                           + 5min冷却
                                  │
                                  ▼
                           恢复 Normal Mode
```

## 7. Channel 通信（7 个）

```
  ┌─────────────────────────────────────────────────────────────────┐
  │                        Channel 拓扑                             │
  │                                                                 │
  │  ── broadcast ──────────────────────────────────────────────   │
  │  lifecycle.rs ──► CapabilityStateChanged                       │
  │                    ├─► quarantine_handler                      │
  │                    ├─► lkg_manager                             │
  │                    └─► notification_handler                    │
  │                                                                 │
  │  self_critic.rs ──► OutcomeAnalyzed                            │
  │                     ├─► capability_score 更新                   │
  │                     └─► narrative_event 写入                    │
  │                                                                 │
  │  ── watch ──────────────────────────────────────────────────   │
  │  affect.rs ──► AffectState                                     │
  │                ├─► Runtime（RestMode 判断）                      │
  │                └─► cognition（arousal 调制）                     │
  │                                                                 │
  │  budget.rs ──► ResourceBudget ──► admission.rs                 │
  │                                                                 │
  │  ── mpsc ───────────────────────────────────────────────────   │
  │  回放/固化/叙事 ──► SpontaneousThought ──► Runtime tick 步骤1   │
  │  feedback.rs ──► FeedbackSignal ──► self_critic.rs             │
  │                                                                 │
  │  ── oneshot ────────────────────────────────────────────────   │
  │  slow_path task ──► DeliberateDecision ──► arbitration.rs      │
  │                                                                 │
  └─────────────────────────────────────────────────────────────────┘
```

## 8. 端到端数据流（用户输入 → 响应）

```
  用户键入 "帮我读取 config.json"
       │
       ▼
  ┌─ stream.rs ─────────────────────────────────────────────┐
  │  commit_window 600ms 静默等待                            │
  │  context_version+1 → CancellationToken 取消旧推理        │
  └──────────────────────────┬──────────────────────────────┘
                              │ SensoryEvent(External)
                              ▼
  ┌─ gating.rs ─────────────────────────────────────────────┐
  │  四维打分: novelty=0.7 urgency=0.3 complexity=0.4       │
  │  task_relevance=0.8 → score=0.56 > noise_floor(0.20)   │
  │  通过门控                                                │
  └──────────────────────────┬──────────────────────────────┘
                              │
                              ▼
  ┌─ router.rs ─────────────────────────────────────────────┐
  │  TextDialogue → 高优先级路由                              │
  └──────────────────────────┬──────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
  ┌─ fast_path.rs ──────┐  ┌─ slow_path.rs ──────────────┐
  │ capability 匹配:     │  │ tokio::spawn                │
  │ "file_reader" 命中   │  │ LLM 分解: read_file(path)  │
  │ → ReflexDecision    │  │ → DeliberateDecision        │
  │ confidence=0.85     │  │ confidence=0.90             │
  └──────────┬──────────┘  └──────────┬──────────────────┘
             │                        │
             ▼                        ▼
  ┌─ arbitration.rs ────────────────────────────────────────┐
  │  Normal压力: slow×0.6(0.54) vs fast×0.4(0.34)          │
  │  选择 slow path → 调用 file_reader capability           │
  └──────────────────────────┬──────────────────────────────┘
                              │
                              ▼
  ┌─ executor.rs ───────────────────────────────────────────┐
  │  IPC: CapabilityRequest → file_reader 子进程             │
  │  CapabilityResponse: {content: "..."} → Outcome(Success)│
  └──────────────────────────┬──────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    ▼                   ▼
  ┌─ self_critic.rs ────┐  ┌─ memory ──────────────────────┐
  │ Outcome → 更新       │  │ 工作记忆写入                   │
  │ file_reader score   │  │ 情节记忆持久化                  │
  │ usage+1, success+1  │  │ narrative_event（首次能力使用） │
  └─────────────────────┘  └────────────────────────────────┘
                              │
                              ▼
                         输出给用户
```

## 9. 休眠/恢复周期

```
  ┌──────────────────────────────────────────────────┐
  │              能量状态机 (affect.rs)                │
  │                                                  │
  │  energy 变化:                                     │
  │    LLM 调用    → -0.03                           │
  │    空闲 tick   → +0.02                           │
  │    valence:  confirmed +0.10 / error -0.15       │
  │    arousal:  Critical +0.30 / 衰减 ×0.95         │
  └──────────────────────┬───────────────────────────┘
                         │
              ┌──────────┴──────────┐
              │                     │
     energy < 0.2              energy ≥ 0.8
     且无活跃会话              或用户输入到达
              │                     │
              ▼                     │
     ┌──────────────┐              │
     │  Rest Mode   │              │
     │  tick=2000ms │──────────────┘
     │              │  唤醒
     │  执行:       │
     │  · 记忆固化  │
     │  · 经验回放  │
     │  · 叙事合成  │
     │  · 资源维护  │
     └──────────────┘
```

## 10. Runtime 模块细节

```
  ┌─ runtime/ ─────────────────────────────────────────────┐
  │                                                         │
  │  scheduler.rs    8步tick循环主调度器                      │
  │    ├─ process_event()    快慢路径 → 融合 → 执行          │
  │    ├─ execute_direct_llm_fallback()  LLM直接响应        │
  │    ├─ execute_capability_invocation() 能力调用           │
  │    ├─ submit_codegen_gap()  异步codegen提交              │
  │    ├─ send_response()  输出channel发送                   │
  │    └─ store_response() 响应写入工作记忆                   │
  │                                                         │
  │  loop_control.rs  TickMode状态机                         │
  │    Normal(100ms) ↔ Idle(500ms) ↔ Rest(2000ms)          │
  │                                                         │
  │  rest_cycle.rs   RestMode进入/退出/最大tick管理           │
  │    enter条件: energy<0.2 且无外部事件                     │
  │    exit条件: energy≥0.8 或用户输入 或max_rest_ticks      │
  │                                                         │
  │  shutdown.rs     CancellationToken优雅关闭               │
  │    SIGTERM/SIGINT → cancel → 15s drain                  │
  └─────────────────────────────────────────────────────────┘

  ┌─ dialogue/ ────────────────────────────────────────────┐
  │  context_version.rs  Arc<AtomicU64> 上下文版本计数器     │
  │    外部输入到达 → bump() → 旧slow path结果判定为stale    │
  │  commit_window.rs    600ms静默提交窗口                   │
  │  topic_tracking.rs   主题追踪                            │
  │  interrupt.rs        CancellationToken取消旧推理         │
  │  feedback.rs         关键词反馈检测 → affect更新          │
  └────────────────────────────────────────────────────────┘

  ┌─ cognition/ ───────────────────────────────────────────┐
  │  perception.rs   规则特征提取 → PerceptFeature           │
  │    compute_threat()  威胁词命中率                         │
  │    compute_complexity() 长度+词汇多样性                   │
  │    classify_intent()  question/command/feedback/         │
  │                       request/statement                  │
  │  fast_path.rs    关键词capability匹配 或 DirectLlmFallback│
  │  slow_path.rs    tokio::spawn LLM异步推理                │
  │  arbitration.rs  快慢融合 + PressureState状态机          │
  │  direct_response.rs  工作记忆上下文 → LLM生成响应         │
  └────────────────────────────────────────────────────────┘

  ┌─ environment/ ─────────────────────────────────────────┐
  │  system.rs                                              │
  │    CpuSampler   /proc/stat delta采样 → usage_ratio     │
  │    RamSnapshot  /proc/meminfo → used_mb/total_mb       │
  │    SystemInfo   OS/CPU核数/总RAM                         │
  │  hardware.rs    电池/网络快照                             │
  │  watcher.rs     周期采集 → 降级信号                      │
  └────────────────────────────────────────────────────────┘
```
